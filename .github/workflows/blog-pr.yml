name: Auto Create Blog Post PR

on:
  issues:
    types: [opened]

jobs:
  create-blog-pr:
    runs-on: ubuntu-latest
    # Optional: Run only if the issue title starts with "[Blog Post]"
    if: startsWith(github.event.issue.title, '[Blog Post]')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Extract Inputs from Issue Body
        id: extract
        shell: bash
        run: |
          # Save the issue body into a variable
          ISSUE_BODY="${{ github.event.issue.body }}"
          echo "Issue body:"
          echo "$ISSUE_BODY"

          # Parse each field from the issue body using grep and sed.
          # Adjust the regular expressions as needed based on your form output.
          BLOG_TITLE=$(echo "$ISSUE_BODY" | awk '/### Blog Title/{getline; print}' | xargs)

      - name: Create Blog Directory and Markdown File
        run: |
          SLUG="${{ steps.extract.outputs.slug }}"
          # Create a directory for the blog post (e.g., under content/blog)
          mkdir -p "content/blog/${SLUG}"
          # Create an initial Markdown file with front matter using the extracted inputs
          cat > "content/blog/${SLUG}/index.md" <<EOF
          ---
          title: "${{ steps.extract.outputs.blog_title }}"
          date: "${{ steps.extract.outputs.blog_date }}"
          authors: "${{ steps.extract.outputs.blog_authors }}"
          tags: "${{ steps.extract.outputs.blog_tags }}"
          category: "${{ steps.extract.outputs.blog_category }}"
          audience: "${{ steps.extract.outputs.blog_audience }}"
          key_value_proposition: "${{ steps.extract.outputs.blog_key_value_proposition }}"
          keywords: "${{ steps.extract.outputs.blog_keywords }}"
          amd_technical_blog_type: "${{ steps.extract.outputs.blog_amd_technical_blog_type }}"
          amd_developer_type: "${{ steps.extract.outputs.blog_amd_developer_type }}"
          amd_developer_tool: "${{ steps.extract.outputs.blog_amd_developer_tool }}"
          amd_applications: "${{ steps.extract.outputs.blog_amd_applications }}"
          ---
          
          # ${{ steps.extract.outputs.blog_title }}
          
          Write your blog content here.
          EOF

      - name: Commit and Push Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          BRANCH="blog/${{ steps.extract.outputs.slug }}"
          git checkout -b "$BRANCH"
          git add content/blog/${{ steps.extract.outputs.slug }}
          git commit -m "Add blog post: ${{ steps.extract.outputs.blog_title }}"
          git push --set-upstream origin "$BRANCH"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v3
        with:
          branch: "blog/${{ steps.extract.outputs.slug }}"
          title: "Add blog post: ${{ steps.extract.outputs.blog_title }}"
          commit-message: "Automated blog post creation for issue #${{ github.event.issue.number }}"
          body: |
            This PR adds a new blog post based on issue #${{ github.event.issue.number }}.
            **Blog Title:** ${{ steps.extract.outputs.blog_title }}
            **Blog Date:** ${{ steps.extract.outputs.blog_date }}
            **Blog Authors:** ${{ steps.extract.outputs.blog_authors }}
            **Blog Tags:** ${{ steps.extract.outputs.blog_tags }}
            **Blog Category:** ${{ steps.extract.outputs.blog_category }}
            **Blog Audience:** ${{ steps.extract.outputs.blog_audience }}
            **Key Value Proposition:** ${{ steps.extract.outputs.blog_key_value_proposition }}
            **Blog Keywords:** ${{ steps.extract.outputs.blog_keywords }}
            **AMD Technical Blog Type:** ${{ steps.extract.outputs.blog_amd_technical_blog_type }}
            **AMD Developer Type:** ${{ steps.extract.outputs.blog_amd_developer_type }}
            **AMD Developer Tool:** ${{ steps.extract.outputs.blog_amd_developer_tool }}
            **AMD Applications:** ${{ steps.extract.outputs.blog_amd_applications }}
